print("Number of used variants")
print(nrow(genotypesSubpop))
numFilteredVariants <- nrow(genotypesSubpop)
sumFilteredVariants <- rowSums(genotypesSubpop)
varcovMat <- cov(genotypesSubpop[,c(T,F)] + genotypesSubpop[,c(F,T)])
numFilteredVariants <- nrow(genotypesSubpop)
sumFilteredVariants <- rowSums(genotypesSubpop)
varcovMat <- cov(genotypesSubpop[,c(T,F)] + genotypesSubpop[,c(F,T)])
totalPossiblePairs <- choose(numSamples,2)
totalPairs <- choose(sumFilteredVariants,2)
weights <- totalPossiblePairs/totalPairs
p <- 1/weights
var_s_hap <- sum((1-p)/p)/(numFilteredVariants^2)
print("variance of s (haploid)")
print(var_s_hap)
# Calculate expected values conditional on kinship
pkweightsMean <- mean(((sumFilteredVariants-2)/numSamples)*weights)
kinships <- seq(0,.25,.001)
kinshipExpectation <- 1+kinships*(pkweightsMean-1)
s_matrix_numerator <- t(genotypesSubpop*weights)%*%genotypesSubpop
s_matrix_denominator <- numFilteredVariants
s_matrix_hap <- s_matrix_numerator/s_matrix_denominator
colnames(s_matrix_hap) <- names(genotypesSubpop)
rownames(s_matrix_hap) <- names(genotypesSubpop)
print(mean(s_matrix_hap[row(s_matrix_hap)!=col(s_matrix_hap)]))
print(median(s_matrix_hap[row(s_matrix_hap)!=col(s_matrix_hap)]))
estimatedKinship <- (s_matrix_hap-1)/(pkweightsMean-1)
# Collapse to diploid
s_matrix_dip <- (s_matrix_hap[c(T,F),c(T,F)] + s_matrix_hap[c(F,T),c(T,F)] +s_matrix_hap[c(T,F),c(F,T)] + s_matrix_hap[c(F,T),c(F,T)])/4
colnames(genotypesSubpop)
colnames(s_matrix_dip) <- colnames(genotypesSubpop)[c(T,F)]
rownames(s_matrix_dip) <- colnames(genotypesSubpop)[c(T,F)]
s_matrix_dip[1:5,1:5]
var_s_dip <- var_s_hap/4
sampleIDs
subpop
qcFilter
if(is.null(qcFilter)){
filterhap <- hap.pop%in%subpop
filterdip <- pop%in%subpop
} else {
filterhap <- hap.pop%in%subpop & rep(qcFilter,each=2)
filterdip <- pop%in%subpop & qcFilter
}
filterhap
result <- readRDS(paste0("./plots/s_distributions/",outputDir,"/plotdata/",pop_i, "_data.rds"))
colnames(result$s_matrix_dip) <- sampleIDs[filterdip]
result$s_matrix_dip[1:5,1:5]
colnames(result$s_matrix_hap) <- sampleIDs[filterhap]
rownames(result$s_matrix_hap) <- sampleIDs[filterhap]
saveRDS(result,paste0("./plots/s_distributions/",outputDir,"/plotdata/",pop_i, "_data.rds"))
result <- readRDS(paste0("./plots/s_distributions/",outputDir,"/plotdata/",pop_i, "_data.rds"))
colnames(result$s_matrix_dip)
resTableAll <- sapply(unique(pop),function(subpop){
if(is.null(qcFilter)){
filterhap <- hap.pop%in%subpop
filterdip <- pop%in%subpop
} else {
filterhap <- hap.pop%in%subpop & rep(qcFilter,each=2)
filterdip <- pop%in%subpop & qcFilter
}
result <- readRDS(paste0("./plots/s_distributions/",outputDir,"/plotdata/",pop_i, "_data.rds"))
colnames(result$s_matrix_dip) <- sampleIDs[filterdip]
rownames(result$s_matrix_dip) <- sampleIDs[filterdip]
colnames(result$s_matrix_hap) <- sampleIDs[filterhap]
rownames(result$s_matrix_hap) <- sampleIDs[filterhap]
saveRDS(result,paste0("./plots/s_distributions/",outputDir,"/plotdata/",pop_i, "_data.rds"))
})
outputDir
outputDir<-"filtered40_LD40"
resTableAll <- sapply(unique(pop),function(subpop){
if(is.null(qcFilter)){
filterhap <- hap.pop%in%subpop
filterdip <- pop%in%subpop
} else {
filterhap <- hap.pop%in%subpop & rep(qcFilter,each=2)
filterdip <- pop%in%subpop & qcFilter
}
result <- readRDS(paste0("./plots/s_distributions/",outputDir,"/plotdata/",pop_i, "_data.rds"))
colnames(result$s_matrix_dip) <- sampleIDs[filterdip]
rownames(result$s_matrix_dip) <- sampleIDs[filterdip]
colnames(result$s_matrix_hap) <- sampleIDs[filterhap]
rownames(result$s_matrix_hap) <- sampleIDs[filterhap]
saveRDS(result,paste0("./plots/s_distributions/",outputDir,"/plotdata/",pop_i, "_data.rds"))
})
if(is.null(qcFilter)){
filterhap <- hap.pop%in%subpop
filterdip <- pop%in%subpop
} else {
filterhap <- hap.pop%in%subpop & rep(qcFilter,each=2)
filterdip <- pop%in%subpop & qcFilter
}
result <- readRDS(paste0("./plots/s_distributions/",outputDir,"/plotdata/",pop_i, "_data.rds"))
colnames(result$s_matrix_dip) <- sampleIDs[filterdip]
rownames(result$s_matrix_dip) <- sampleIDs[filterdip]
colnames(result$s_matrix_hap) <- sampleIDs[filterhap]
rownames(result$s_matrix_hap) <- sampleIDs[filterhap]
saveRDS(result,paste0("./plots/s_distributions/",outputDir,"/plotdata/",pop_i, "_data.rds"))
subpop<-"GBR"
if(is.null(qcFilter)){
filterhap <- hap.pop%in%subpop
filterdip <- pop%in%subpop
} else {
filterhap <- hap.pop%in%subpop & rep(qcFilter,each=2)
filterdip <- pop%in%subpop & qcFilter
}
result <- readRDS(paste0("./plots/s_distributions/",outputDir,"/plotdata/",pop_i, "_data.rds"))
colnames(result$s_matrix_dip) <- sampleIDs[filterdip]
rownames(result$s_matrix_dip) <- sampleIDs[filterdip]
colnames(result$s_matrix_hap) <- sampleIDs[filterhap]
rownames(result$s_matrix_hap) <- sampleIDs[filterhap]
saveRDS(result,paste0("./plots/s_distributions/",outputDir,"/plotdata/",pop_i, "_data.rds"))
filterdip
sum(filterdip)
if(is.null(qcFilter)){
filterhap <- hap.pop%in%subpop
filterdip <- pop%in%subpop
} else {
filterhap <- hap.pop%in%subpop & rep(qcFilter,each=2)
filterdip <- pop%in%subpop & qcFilter
}
result <- readRDS(paste0("./plots/s_distributions/",outputDir,"/plotdata/",pop_i, "_data.rds"))
colnames(result$s_matrix_dip) <- sampleIDs[filterdip]
colnames(result$s_matrix_dip)
sampleIDs[filterdip]
resTableAll <- sapply(unique(pop),function(subpop){
if(is.null(qcFilter)){
filterhap <- hap.pop%in%subpop
filterdip <- pop%in%subpop
} else {
filterhap <- hap.pop%in%subpop & rep(qcFilter,each=2)
filterdip <- pop%in%subpop & qcFilter
}
result <- readRDS(paste0("./plots/s_distributions/",outputDir,"/plotdata/",subpop, "_data.rds"))
colnames(result$s_matrix_dip) <- sampleIDs[filterdip]
rownames(result$s_matrix_dip) <- sampleIDs[filterdip]
colnames(result$s_matrix_hap) <- sampleIDs[filterhap]
rownames(result$s_matrix_hap) <- sampleIDs[filterhap]
saveRDS(result,paste0("./plots/s_distributions/",outputDir,"/plotdata/",subpop, "_data.rds"))
})
names(popResults)[1] <- "pop"
popResults$group <- popGroup[popResults$pop,"group"]
pdf(paste0("./plots/s_distributions/",outputDir,"/pValueForPop.pdf"), width=8, height=8)
ggplot(popResults, aes(y=structurePValue, x=pop))+ geom_point(aes(color=group)) + geom_hline(yintercept=.05) + geom_hline(yintercept=.01) +
ggtitle("p-value for structure in each population") + theme_bw() +
theme(axis.text.x = element_text(angle = 90, hjust = 1))
dev.off()
# ggplot(subset(popResults,!pop%in%c("PEL","MXL","ASW","PUR")), aes(y=var_s, x=sampleVariance, label=pop))+ geom_point(col="red", size=5) + geom_text(aes(y=var_s, x=sampleVariance))+ geom_abline() +
#     xlim(0,.005)+ylim(0,.005)
cor(subset(popResults,!pop%in%c("PEL","MXL","ASW","PUR"))$sampleVariance,subset(popResults,!pop%in%c("PEL","MXL","ASW","PUR"))$var_s)
varianceRatio <- popResults$sampleVariance/popResults$var_s
names(varianceRatio)<-popResults$pop
cbind(sort(varianceRatio, decreasing = TRUE))
sum(popResults$structurePValue<.01)
popResults$structurePValue[popResults$structurePValue<.01]
popResults <- popResults[order(popResults$structurePValue),]
structuredPops <- popResults$pop[popResults$structurePValue<.05]
# generate summary table --------------------------------------------------
resTableAll <- data.table(do.call(rbind, lapply(unique(pop),function(pop_i){
result <- readRDS(paste0("./plots/s_distributions/",outputDir,"/plotdata/",pop_i, "_data.rds"))
result$s_matrix_dip[upper.tri(result$s_matrix_dip)] <- NA
diag(result$s_matrix_dip) <- NA
resTable <- melt(result$s_matrix_dip, na.rm=T)
resTable$estimatedCoK <- (resTable$value-1)/(result$pkweightsMean-1)
resTable$pop <- pop_i
colnames(resTable) <- c("SampleID_1","SampleID_2","s","CoK","pop")
resTable
})))
gazal_related <- read.csv("./data/gazal_related.csv")
gazal_related <- data.table(gazal_related)
gazal_related_rev <- copy(gazal_related)
setcolorder(gazal_related_rev, c(2,1,3,4,5))
names(gazal_related_rev)[1:2] <- names(gazal_related_rev)[2:1]
gazal_related <- rbind(gazal_related,gazal_related_rev)
names(gazal_related)[1:2] <- names(resTableAll)[1:2]
resTableAll <- merge(resTableAll,gazal_related, by=names(gazal_related)[1:2],all.x=T)
resTableAll$group <- popGroup[resTableAll$pop,"group"]
sum(!is.na(resTableAll[,INFERED.RELATIONSHIP]))
resTableAll[SampleID_1=="HG00100"]
resTableAll[is.na(resTableAll[["INFERED.RELATIONSHIP"]]),"INFERED.RELATIONSHIP"]<- "Unrelated"
resTableAll$CombinedInfered <- "Unrelated"
resTableAll$CombinedInfered[resTableAll$INFERED.RELATIONSHIP=="CO"] <- "CO"
resTableAll$CombinedInfered[resTableAll$INFERED.RELATIONSHIP=="AV"|resTableAll$INFERED.RELATIONSHIP=="HS"] <- "AV or HS"
resTableAll$CombinedInfered[resTableAll$INFERED.RELATIONSHIP=="FS"|resTableAll$INFERED.RELATIONSHIP=="PO"] <- "FS or PO"
resTableAll[order(-CoK)]
ggplot(resTableAll, aes(CombinedInfered, CoK)) +
geom_jitter(aes(alpha=(INFERED.RELATIONSHIP!="Unrelated")*.02)) + scale_x_discrete(limits=levels(resTableAll$INFERED.RELATIONSHIP)[c(6,2,1,4,3,5)])
ggplot(resTableAll, aes(INFERED.RELATIONSHIP, CoK)) +
geom_boxplot() + scale_x_discrete(limits=levels(resTableAll$INFERED.RELATIONSHIP)[c(6,2,1,4,3,5)]) +xlab("Inferred Relationship (Gazal 2015)") + ylab("Estimated kinship")
pdf(paste0("./plots/s_distributions/",outputDir,"/EstimatedCoKvsGazal.pdf"), width=8, height=8)
ggplot(resTableAll, aes(CombinedInfered, CoK)) + theme_bw() +
geom_boxplot() + geom_jitter(aes(color=group), alpha=.5) + scale_x_discrete(limits=c("Unrelated","CO","AV or HS", "FS or PO")) +
xlab("Inferred Relationship (Gazal 2015)") + ylab("Estimated kinship") + ggtitle("Our estimated CoK vs Inferred Relationship (Gazal 2015)")
dev.off()
ggplot(subset(resTableAll, !pop%in%structuredPops), aes(CombinedInfered, CoK)) + theme_bw() +
geom_boxplot() + geom_jitter(aes(color=group), alpha=.5) + scale_x_discrete(limits=c("Unrelated","CO","AV or HS", "FS or PO")) +
xlab("Inferred Relationship (Gazal 2015)") + ylab("Estimated kinship") + ggtitle("Our estimated CoK vs Inferred Relationship (Gazal 2015)")
names(popResults)[1] <- "pop"
popResults <- as.data.table(t(sapply(names(results), function(pop_i){
s_vector <- results[[pop_i]]$s_matrix_dip[row(results[[pop_i]]$s_matrix_dip)>col(results[[pop_i]]$s_matrix_dip)]
topValuesKinship <- (sort(s_vector, decreasing=T)-1)/(results[[pop_i]]$weightsMean-1)
btest <- binom.test(sum(s_vector>mean(s_vector)), length(s_vector), alternative="less")
c(structurePValue=btest$p.value, var_s=results[[pop_i]]$var_s_dip, sampleVariance=var(s_vector))
})), keep.rownames=T)
resTableAll <- sapply(unique(pop),function(subpop){
if(is.null(qcFilter)){
filterhap <- hap.pop%in%subpop
filterdip <- pop%in%subpop
} else {
filterhap <- hap.pop%in%subpop & rep(qcFilter,each=2)
filterdip <- pop%in%subpop & qcFilter
}
result <- readRDS(paste0("./plots/s_distributions/",outputDir,"/plotdata/",subpop, "_data.rds"))
colnames(result$s_matrix_dip) <- sampleIDs[filterdip]
rownames(result$s_matrix_dip) <- sampleIDs[filterdip]
colnames(result$s_matrix_hap) <- sampleIDs[filterhap]
rownames(result$s_matrix_hap) <- sampleIDs[filterhap]
saveRDS(result,paste0("./plots/s_distributions/",outputDir,"/plotdata/",subpop, "_data.rds"))
colnames(results[[subpop]]$s_matrix_dip) <- sampleIDs[filterdip]
rownames(results[[subpop]]$s_matrix_dip) <- sampleIDs[filterdip]
colnames(results[[subpop]]$s_matrix_hap) <- sampleIDs[filterhap]
rownames(results[[subpop]]$s_matrix_hap) <- sampleIDs[filterhap]
})
saveRDS(results, paste0("./plots/s_distributions/",outputDir,"/plotdata/all_data.rds"))
results <- readRDS(paste0("./plots/s_distributions/",outputDir,"/plotdata/all_data.rds"))
##### Fix for results which don't contain samplenames, delete when no longer necessary
resTableAll <- sapply(unique(pop),function(subpop){
if(is.null(qcFilter)){
filterhap <- hap.pop%in%subpop
filterdip <- pop%in%subpop
} else {
filterhap <- hap.pop%in%subpop & rep(qcFilter,each=2)
filterdip <- pop%in%subpop & qcFilter
}
result <- readRDS(paste0("./plots/s_distributions/",outputDir,"/plotdata/",subpop, "_data.rds"))
colnames(result$s_matrix_dip) <- sampleIDs[filterdip]
rownames(result$s_matrix_dip) <- sampleIDs[filterdip]
colnames(result$s_matrix_hap) <- sampleIDs[filterhap]
rownames(result$s_matrix_hap) <- sampleIDs[filterhap]
saveRDS(result,paste0("./plots/s_distributions/",outputDir,"/plotdata/",subpop, "_data.rds"))
colnames(results[[subpop]]$s_matrix_dip) <- sampleIDs[filterdip]
rownames(results[[subpop]]$s_matrix_dip) <- sampleIDs[filterdip]
colnames(results[[subpop]]$s_matrix_hap) <- sampleIDs[filterhap]
rownames(results[[subpop]]$s_matrix_hap) <- sampleIDs[filterhap]
})
saveRDS(results, paste0("./plots/s_distributions/",outputDir,"/plotdata/all_data.rds"))
results <- readRDS(paste0("./plots/s_distributions/",outputDir,"/plotdata/all_data.rds"))
outputDir
results <- readRDS(paste0("./plots/s_distributions/",outputDir,"/plotdata/all_data.rds"))
results <- readRDS(paste0("./plots/s_distributions/",outputDir,"/plotdata/alld_data.rds"))
outputDir <- 'filtered40_LD40'
sample <- read.table("~/1000GP/data/1000GP_Phase3.sample", sep=" ", header=T)
sampleIDs <- as.character(sample[,1])
pop <- as.character(sample[,2])
group <- as.character(sample[,3])
sex <- as.character(sample[,4])
hap.pop <- rep(pop,each=2)
hap.sampleIDs <- rep(as.character(sample[,1]),each=2)
popGroup <- melt(table(pop,group))
popGroup <- popGroup[popGroup$value>0,]
rownames(popGroup) <- popGroup$pop
library(ggplot2)
library(reshape2)
library(data.table)
library(gtools)
sample <- read.table("~/1000GP/data/1000GP_Phase3.sample", sep=" ", header=T)
sampleIDs <- as.character(sample[,1])
pop <- as.character(sample[,2])
group <- as.character(sample[,3])
sex <- as.character(sample[,4])
hap.pop <- rep(pop,each=2)
hap.sampleIDs <- rep(as.character(sample[,1]),each=2)
popGroup <- melt(table(pop,group))
popGroup <- popGroup[popGroup$value>0,]
rownames(popGroup) <- popGroup$pop
source('~/1000GP/s_matrix_functions.R')
results <- readRDS(paste0("./plots/s_distributions/",outputDir,"/plotdata/all_data.rds"))
results <- readRDS(paste0("./plots/s_distributions/",outputDir,"/plotdata/all_data.rds"))
resTableAll <- sapply(unique(pop),function(subpop){
if(is.null(qcFilter)){
filterhap <- hap.pop%in%subpop
filterdip <- pop%in%subpop
} else {
filterhap <- hap.pop%in%subpop & rep(qcFilter,each=2)
filterdip <- pop%in%subpop & qcFilter
}
result <- readRDS(paste0("./plots/s_distributions/",outputDir,"/plotdata/",subpop, "_data.rds"))
colnames(result$s_matrix_dip) <- sampleIDs[filterdip]
rownames(result$s_matrix_dip) <- sampleIDs[filterdip]
colnames(result$s_matrix_hap) <- sampleIDs[filterhap]
rownames(result$s_matrix_hap) <- sampleIDs[filterhap]
saveRDS(result,paste0("./plots/s_distributions/",outputDir,"/plotdata/",subpop, "_data.rds"))
colnames(results[[subpop]]$s_matrix_dip) <- sampleIDs[filterdip]
rownames(results[[subpop]]$s_matrix_dip) <- sampleIDs[filterdip]
colnames(results[[subpop]]$s_matrix_hap) <- sampleIDs[filterhap]
rownames(results[[subpop]]$s_matrix_hap) <- sampleIDs[filterhap]
})
gazalFilter <- "NA"
if(gazalFilter=="NA"|is.na(gazalFilter)){
qcFilter <- NULL
} else {
gazal_filtered <- read.csv("./data/gazal_filtered.csv",stringsAsFactors=F)
gazal_filtered <- gazal_filtered[order(gazal_filtered[,1]),]
qcFilter <- gazal_filtered[,gazalFilter]=="YES"
}
resTableAll <- sapply(unique(pop),function(subpop){
if(is.null(qcFilter)){
filterhap <- hap.pop%in%subpop
filterdip <- pop%in%subpop
} else {
filterhap <- hap.pop%in%subpop & rep(qcFilter,each=2)
filterdip <- pop%in%subpop & qcFilter
}
result <- readRDS(paste0("./plots/s_distributions/",outputDir,"/plotdata/",subpop, "_data.rds"))
colnames(result$s_matrix_dip) <- sampleIDs[filterdip]
rownames(result$s_matrix_dip) <- sampleIDs[filterdip]
colnames(result$s_matrix_hap) <- sampleIDs[filterhap]
rownames(result$s_matrix_hap) <- sampleIDs[filterhap]
saveRDS(result,paste0("./plots/s_distributions/",outputDir,"/plotdata/",subpop, "_data.rds"))
colnames(results[[subpop]]$s_matrix_dip) <- sampleIDs[filterdip]
rownames(results[[subpop]]$s_matrix_dip) <- sampleIDs[filterdip]
colnames(results[[subpop]]$s_matrix_hap) <- sampleIDs[filterhap]
rownames(results[[subpop]]$s_matrix_hap) <- sampleIDs[filterhap]
})
saveRDS(results, paste0("./plots/s_distributions/",outputDir,"/plotdata/all_data.rds"))
sapply(names(results), function(pop_i){
s_vector <- results[[pop_i]]$s_matrix_dip[row(results[[pop_i]]$s_matrix_dip)>col(results[[pop_i]]$s_matrix_dip)]
plotFromGSM(subpop=pop_i, gsm=results[[pop_i]]$s_matrix_dip, var_s=var(s_vector), pkweightsMean=results[[pop_i]]$pkweightsMean, "diploid", outputDir=outputDir)
})
popResults <- as.data.table(t(sapply(names(results), function(pop_i){
s_vector <- results[[pop_i]]$s_matrix_dip[row(results[[pop_i]]$s_matrix_dip)>col(results[[pop_i]]$s_matrix_dip)]
topValuesKinship <- (sort(s_vector, decreasing=T)-1)/(results[[pop_i]]$weightsMean-1)
btest <- binom.test(sum(s_vector>mean(s_vector)), length(s_vector), alternative="less")
c(structurePValue=btest$p.value, var_s=results[[pop_i]]$var_s_dip, sampleVariance=var(s_vector))
})), keep.rownames=T)
names(popResults)[1] <- "pop"
popResults$group <- popGroup[popResults$pop,"group"]
pdf(paste0("./plots/s_distributions/",outputDir,"/pValueForPop.pdf"), width=8, height=8)
ggplot(popResults, aes(y=structurePValue, x=pop))+ geom_point(aes(color=group)) + geom_hline(yintercept=.05) + geom_hline(yintercept=.01) +
ggtitle("p-value for structure in each population") + theme_bw() +
theme(axis.text.x = element_text(angle = 90, hjust = 1))
dev.off()
# ggplot(subset(popResults,!pop%in%c("PEL","MXL","ASW","PUR")), aes(y=var_s, x=sampleVariance, label=pop))+ geom_point(col="red", size=5) + geom_text(aes(y=var_s, x=sampleVariance))+ geom_abline() +
#     xlim(0,.005)+ylim(0,.005)
cor(subset(popResults,!pop%in%c("PEL","MXL","ASW","PUR"))$sampleVariance,subset(popResults,!pop%in%c("PEL","MXL","ASW","PUR"))$var_s)
varianceRatio <- popResults$sampleVariance/popResults$var_s
names(varianceRatio)<-popResults$pop
cbind(sort(varianceRatio, decreasing = TRUE))
sum(popResults$structurePValue<.01)
popResults$structurePValue[popResults$structurePValue<.01]
popResults <- popResults[order(popResults$structurePValue),]
structuredPops <- popResults$pop[popResults$structurePValue<.05]
resTableAll <- data.table(do.call(rbind, lapply(unique(pop),function(pop_i){
result <- readRDS(paste0("./plots/s_distributions/",outputDir,"/plotdata/",pop_i, "_data.rds"))
result$s_matrix_dip[upper.tri(result$s_matrix_dip)] <- NA
diag(result$s_matrix_dip) <- NA
resTable <- melt(result$s_matrix_dip, na.rm=T)
resTable$estimatedCoK <- (resTable$value-1)/(result$pkweightsMean-1)
resTable$pop <- pop_i
colnames(resTable) <- c("SampleID_1","SampleID_2","s","CoK","pop")
resTable
})))
gazal_related <- read.csv("./data/gazal_related.csv")
gazal_related <- data.table(gazal_related)
gazal_related_rev <- copy(gazal_related)
setcolorder(gazal_related_rev, c(2,1,3,4,5))
names(gazal_related_rev)[1:2] <- names(gazal_related_rev)[2:1]
gazal_related <- rbind(gazal_related,gazal_related_rev)
names(gazal_related)[1:2] <- names(resTableAll)[1:2]
resTableAll <- merge(resTableAll,gazal_related, by=names(gazal_related)[1:2],all.x=T)
resTableAll$group <- popGroup[resTableAll$pop,"group"]
sum(!is.na(resTableAll[,INFERED.RELATIONSHIP]))
resTableAll[SampleID_1=="HG00100"]
resTableAll[is.na(resTableAll[["INFERED.RELATIONSHIP"]]),"INFERED.RELATIONSHIP"]<- "Unrelated"
resTableAll$CombinedInfered <- "Unrelated"
resTableAll$CombinedInfered[resTableAll$INFERED.RELATIONSHIP=="CO"] <- "CO"
resTableAll$CombinedInfered[resTableAll$INFERED.RELATIONSHIP=="AV"|resTableAll$INFERED.RELATIONSHIP=="HS"] <- "AV or HS"
resTableAll$CombinedInfered[resTableAll$INFERED.RELATIONSHIP=="FS"|resTableAll$INFERED.RELATIONSHIP=="PO"] <- "FS or PO"
resTableAll[order(-CoK)]
ggplot(resTableAll, aes(CombinedInfered, CoK)) +
geom_jitter(aes(alpha=(INFERED.RELATIONSHIP!="Unrelated")*.02)) + scale_x_discrete(limits=levels(resTableAll$INFERED.RELATIONSHIP)[c(6,2,1,4,3,5)])
ggplot(resTableAll, aes(INFERED.RELATIONSHIP, CoK)) +
geom_boxplot() + scale_x_discrete(limits=levels(resTableAll$INFERED.RELATIONSHIP)[c(6,2,1,4,3,5)]) +xlab("Inferred Relationship (Gazal 2015)") + ylab("Estimated kinship")
pdf(paste0("./plots/s_distributions/",outputDir,"/EstimatedCoKvsGazal.pdf"), width=8, height=8)
ggplot(resTableAll, aes(CombinedInfered, CoK)) + theme_bw() +
geom_boxplot() + geom_jitter(aes(color=group), alpha=.5) + scale_x_discrete(limits=c("Unrelated","CO","AV or HS", "FS or PO")) +
xlab("Inferred Relationship (Gazal 2015)") + ylab("Estimated kinship") + ggtitle("Our estimated CoK vs Inferred Relationship (Gazal 2015)")
dev.off()
ggplot(subset(resTableAll, !pop%in%structuredPops), aes(CombinedInfered, CoK)) + theme_bw() +
geom_boxplot() + geom_jitter(aes(color=group), alpha=.5) + scale_x_discrete(limits=c("Unrelated","CO","AV or HS", "FS or PO")) +
xlab("Inferred Relationship (Gazal 2015)") + ylab("Estimated kinship") + ggtitle("Our estimated CoK vs Inferred Relationship (Gazal 2015)")
library(ggplot2)
library(reshape2)
library(data.table)
library(gtools)
#outputDir <- "filtered1000_fixed_phi"
#genotypeFile <- "./data/1000GP_Phase3_chr10.hap.gz"
genotypeFile <- "./data/combinedFiltered40.gz"
numberOfLines <- 5000
minVariants <- 10
numCores <- 4
args<-commandArgs(TRUE)
outputDir <- '.'
# gazalFilter <-"TGP2261"
gazalFilter <- "NA"
ldPrune <- 10
if(length(args)!=0){
genotypeFile <- args[1]
numberOfLines <- as.numeric(args[2])
minVariants <- as.numeric(args[3])
numCores <- as.numeric(args[4])
outputDir <- args[5]
gazalFilter <- args[6]
ldPrune <- as.numeric(args[7])
dir.create(paste0("~/1000GP/plots/s_distributions/",outputDir))
dir.create(paste0("~/1000GP/plots/s_distributions/",outputDir,"/plotdata"))
}
# incorporating gazal filtering -------------------------------------------
if(gazalFilter=="NA"|is.na(gazalFilter)){
qcFilter <- NULL
} else {
gazal_filtered <- read.csv("./data/gazal_filtered.csv",stringsAsFactors=F)
gazal_filtered <- gazal_filtered[order(gazal_filtered[,1]),]
qcFilter <- gazal_filtered[,gazalFilter]=="YES"
}
# Real data
sample <- read.table("~/1000GP/data/1000GP_Phase3.sample", sep=" ", header=T)
sampleIDs <- as.character(sample[,1])
pop <- as.character(sample[,2])
group <- as.character(sample[,3])
sex <- as.character(sample[,4])
hap.pop <- rep(pop,each=2)
hap.sampleIDs <- rep(as.character(sample[,1]),each=2)
popGroup <- melt(table(pop,group))
popGroup <- popGroup[popGroup$value>0,]
rownames(popGroup) <- popGroup$pop
source('~/1000GP/s_matrix_functions.R')
# library(foreach)
# library(doParallel)
# Initiate cluster
# if(!is.na(numCores)){
#     cl <- makeCluster(numCores)
#     registerDoParallel(cl)
# }
outputDir <- "filtered40_LD40"
results <- readRDS(paste0("./plots/s_distributions/",outputDir,"/plotdata/all_data.rds"))
sapply(names(results), function(pop_i){
s_vector <- results[[pop_i]]$s_matrix_dip[row(results[[pop_i]]$s_matrix_dip)>col(results[[pop_i]]$s_matrix_dip)]
plotFromGSM(subpop=pop_i, gsm=results[[pop_i]]$s_matrix_dip, var_s=var(s_vector), pkweightsMean=results[[pop_i]]$pkweightsMean, "diploid", outputDir=outputDir)
})
popResults <- as.data.table(t(sapply(names(results), function(pop_i){
s_vector <- results[[pop_i]]$s_matrix_dip[row(results[[pop_i]]$s_matrix_dip)>col(results[[pop_i]]$s_matrix_dip)]
topValuesKinship <- (sort(s_vector, decreasing=T)-1)/(results[[pop_i]]$weightsMean-1)
btest <- binom.test(sum(s_vector>mean(s_vector)), length(s_vector), alternative="less")
c(structurePValue=btest$p.value, var_s=results[[pop_i]]$var_s_dip, sampleVariance=var(s_vector))
})), keep.rownames=T)
names(popResults)[1] <- "pop"
popResults$group <- popGroup[popResults$pop,"group"]
pdf(paste0("./plots/s_distributions/",outputDir,"/pValueForPop.pdf"), width=8, height=8)
ggplot(popResults, aes(y=structurePValue, x=pop))+ geom_point(aes(color=group)) + geom_hline(yintercept=.05) + geom_hline(yintercept=.01) +
ggtitle("p-value for structure in each population") + theme_bw() +
theme(axis.text.x = element_text(angle = 90, hjust = 1))
dev.off()
# ggplot(subset(popResults,!pop%in%c("PEL","MXL","ASW","PUR")), aes(y=var_s, x=sampleVariance, label=pop))+ geom_point(col="red", size=5) + geom_text(aes(y=var_s, x=sampleVariance))+ geom_abline() +
#     xlim(0,.005)+ylim(0,.005)
cor(subset(popResults,!pop%in%c("PEL","MXL","ASW","PUR"))$sampleVariance,subset(popResults,!pop%in%c("PEL","MXL","ASW","PUR"))$var_s)
varianceRatio <- popResults$sampleVariance/popResults$var_s
names(varianceRatio)<-popResults$pop
cbind(sort(varianceRatio, decreasing = TRUE))
sum(popResults$structurePValue<.01)
popResults$structurePValue[popResults$structurePValue<.01]
popResults <- popResults[order(popResults$structurePValue),]
structuredPops <- popResults$pop[popResults$structurePValue<.05]
resTableAll <- data.table(do.call(rbind, lapply(unique(pop),function(pop_i){
result <- readRDS(paste0("./plots/s_distributions/",outputDir,"/plotdata/",pop_i, "_data.rds"))
result$s_matrix_dip[upper.tri(result$s_matrix_dip)] <- NA
diag(result$s_matrix_dip) <- NA
resTable <- melt(result$s_matrix_dip, na.rm=T)
resTable$estimatedCoK <- (resTable$value-1)/(result$pkweightsMean-1)
resTable$pop <- pop_i
colnames(resTable) <- c("SampleID_1","SampleID_2","s","CoK","pop")
resTable
})))
gazal_related <- read.csv("./data/gazal_related.csv")
gazal_related <- data.table(gazal_related)
gazal_related_rev <- copy(gazal_related)
setcolorder(gazal_related_rev, c(2,1,3,4,5))
names(gazal_related_rev)[1:2] <- names(gazal_related_rev)[2:1]
gazal_related <- rbind(gazal_related,gazal_related_rev)
names(gazal_related)[1:2] <- names(resTableAll)[1:2]
resTableAll <- merge(resTableAll,gazal_related, by=names(gazal_related)[1:2],all.x=T)
resTableAll$group <- popGroup[resTableAll$pop,"group"]
sum(!is.na(resTableAll[,INFERED.RELATIONSHIP]))
resTableAll[SampleID_1=="HG00100"]
resTableAll[is.na(resTableAll[["INFERED.RELATIONSHIP"]]),"INFERED.RELATIONSHIP"]<- "Unrelated"
resTableAll$CombinedInfered <- "Unrelated"
resTableAll$CombinedInfered[resTableAll$INFERED.RELATIONSHIP=="CO"] <- "CO"
resTableAll$CombinedInfered[resTableAll$INFERED.RELATIONSHIP=="AV"|resTableAll$INFERED.RELATIONSHIP=="HS"] <- "AV or HS"
resTableAll$CombinedInfered[resTableAll$INFERED.RELATIONSHIP=="FS"|resTableAll$INFERED.RELATIONSHIP=="PO"] <- "FS or PO"
resTableAll[order(-CoK)]
ggplot(resTableAll, aes(CombinedInfered, CoK)) +
geom_jitter(aes(alpha=(INFERED.RELATIONSHIP!="Unrelated")*.02)) + scale_x_discrete(limits=levels(resTableAll$INFERED.RELATIONSHIP)[c(6,2,1,4,3,5)])
ggplot(resTableAll, aes(INFERED.RELATIONSHIP, CoK)) +
geom_boxplot() + scale_x_discrete(limits=levels(resTableAll$INFERED.RELATIONSHIP)[c(6,2,1,4,3,5)]) +xlab("Inferred Relationship (Gazal 2015)") + ylab("Estimated kinship")
pdf(paste0("./plots/s_distributions/",outputDir,"/EstimatedCoKvsGazal.pdf"), width=8, height=8)
ggplot(resTableAll, aes(CombinedInfered, CoK)) + theme_bw() +
geom_boxplot() + geom_jitter(aes(color=group), alpha=.5) + scale_x_discrete(limits=c("Unrelated","CO","AV or HS", "FS or PO")) +
xlab("Inferred Relationship (Gazal 2015)") + ylab("Estimated kinship") + ggtitle("Our estimated CoK vs Inferred Relationship (Gazal 2015)")
dev.off()
ggplot(subset(resTableAll, !pop%in%structuredPops), aes(CombinedInfered, CoK)) + theme_bw() +
geom_boxplot() + geom_jitter(aes(color=group), alpha=.5) + scale_x_discrete(limits=c("Unrelated","CO","AV or HS", "FS or PO")) +
xlab("Inferred Relationship (Gazal 2015)") + ylab("Estimated kinship") + ggtitle("Our estimated CoK vs Inferred Relationship (Gazal 2015)")
